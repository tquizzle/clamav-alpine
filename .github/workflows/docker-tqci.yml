name: Docker Image TQ CI

on:
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  dockerhub-login:
    runs-on: ubuntu-latest
    outputs:
      username: ${{ steps.set-username.outputs.username }}
    steps:
      - name: Login to Docker Hub
        id: dockerhub-login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Set DockerHub Username Output
        id: set-username
        run: echo "username=${{ secrets.DOCKER_USERNAME }}" >> $GITHUB_OUTPUT

  ghcr-login:
    runs-on: ubuntu-latest
    steps:
      - name: Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

  extract-metadata:
    runs-on: ubuntu-latest
    needs: [dockerhub-login]
    outputs:
      latest_tags: ${{ steps.meta-latest.outputs.tags }}
      latest_labels: ${{ steps.meta-latest.outputs.labels }}
      edge_tags: ${{ steps.meta-edge.outputs.tags }}
      edge_labels: ${{ steps.meta-edge.outputs.labels }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v5

      - name: Extract metadata for Docker (latest)
        id: meta-latest
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.dockerhub-login.outputs.username }}/clamav-alpine:latest

      - name: Extract metadata for Docker (edge)
        id: meta-edge
        uses: docker/metadata-action@v5
        with:
          images: ${{ needs.dockerhub-login.outputs.username }}/clamav-alpine:edge

  build-and-push-dockerhub:
    runs-on: ubuntu-latest
    needs: [dockerhub-login, extract-metadata]
    steps:
      - name: Check out the repo
        uses: actions/checkout@v5

      - name: Build & Push - Latest
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ needs.extract-metadata.outputs.latest_tags }}
          labels: ${{ needs.extract-metadata.outputs.latest_labels }}

      - name: Build & Push - Edge
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./edge-Dockerfile
          push: true
          tags: ${{ needs.extract-metadata.outputs.edge_tags }}
          labels: ${{ needs.extract-metadata.outputs.edge_labels }}

  build-and-push-ghcr:
    runs-on: ubuntu-latest
    needs: [ghcr-login, extract-metadata]
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
      - name: Check out the repo
        uses: actions/checkout@v5

      - name: Build & Push - Latest (GHCR)
        id: push-latest
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/clamav-alpine:latest
          labels: ${{ needs.extract-metadata.outputs.latest_labels }}

      - name: Generate latest artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.repository }}/clamav-alpine
          subject-digest: ${{ steps.push-latest.outputs.digest }}
          push-to-registry: true

      - name: Build & Push - Edge (GHCR)
        id: push-edge
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./edge-Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/clamav-alpine:edge
          labels: ${{ needs.extract-metadata.outputs.edge_labels }}

      - name: Generate edge artifact attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-name: ghcr.io/${{ github.repository }}/clamav-alpine
          subject-digest: ${{ steps.push-edge.outputs.digest }}
          push-to-registry: true
